name: Auto Update Master & Slave Images (PR Mode)

on:
  repository_dispatch:
    types: [update-image]
  workflow_dispatch:
    inputs:
      master_image:
        required: false
      slave_image:
        required: false

permissions:
  contents: write
  pull-requests: write

env:
  MASTER_FILE: deployment.yaml        # Controller manifest (root)
  SLAVE_FILE: agent-deploy.yaml      # Agent manifest (root)
  OLD_MASTER: jenkins/jenkins:lts-jdk17
  OLD_SLAVE: jenkins/inbound-agent:latest

jobs:
  update-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Read Input Images
        id: imgs
        run: |
          MASTER="${{ github.event.client_payload.master_image }}"
          SLAVE="${{ github.event.client_payload.slave_image }}"
          [ -z "$MASTER" ] && MASTER="${{ github.event.inputs.master_image }}"
          [ -z "$SLAVE" ] && SLAVE="${{ github.event.inputs.slave_image }}"

          # Simple fallbacks (optional)
          if [ -z "$MASTER" ]; then
            MASTER="docker.io/nareshd2/jenkins-master:${GITHUB_SHA::7}"
          fi
          if [ -z "$SLAVE" ]; then
            SLAVE="docker.io/nareshd2/jenkins-slave:${GITHUB_SHA::7}"
          fi

          echo "MASTER_IMAGE=$MASTER" >> $GITHUB_OUTPUT
          echo "SLAVE_IMAGE=$SLAVE" >> $GITHUB_OUTPUT
          echo "Using:"
          echo "  MASTER_IMAGE=$MASTER"
          echo "  SLAVE_IMAGE=$SLAVE"

      - name: Update Master Image in deployment.yaml
        run: |
          FILE="${MASTER_FILE}"
          NEW_IMAGE="${{ steps.imgs.outputs.MASTER_IMAGE }}"
          echo "Before (master):"
          grep -n "image:" "$FILE" || true
          sed -i "s|image: ${OLD_MASTER}|image: ${NEW_IMAGE}|" "$FILE"
          echo "After (master):"
          grep -n "image:" "$FILE" || true

      - name: Update Slave Image in agent-deploy.yaml
        run: |
          FILE="${SLAVE_FILE}"
          NEW_IMAGE="${{ steps.imgs.outputs.SLAVE_IMAGE }}"
          echo "Before (slave):"
          grep -n "image:" "$FILE" || true
          sed -i "s|image: ${OLD_SLAVE}|image: ${NEW_IMAGE}|" "$FILE"
          echo "After (slave):"
          grep -n "image:" "$FILE" || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: |
            Update master to ${{ steps.imgs.outputs.MASTER_IMAGE }}
            Update slave to ${{ steps.imgs.outputs.SLAVE_IMAGE }}
          branch: "auto/update-images"
          delete-branch: true
          title: "Update Master & Slave Jenkins Images"
          body: |
            Automated update:
            - Master Image: `${{ steps.imgs.outputs.MASTER_IMAGE }}`
            - Slave Image: `${{ steps.imgs.outputs.SLAVE_IMAGE }}`
