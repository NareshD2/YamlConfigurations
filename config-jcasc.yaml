apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-jcasc
  namespace: jenkins
data:
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins on Kubernetes (managed by JCasC)"
      numExecutors: 0
      mode: NORMAL
      disableRememberMe: true

      crumbIssuer:
        standard: {}

      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "${JENKINS_ADMIN_ID}"
              password: "${JENKINS_ADMIN_PASSWORD}"

      authorizationStrategy:
        loggedInUsersCanDoAnything:
          allowAnonymousRead: false

      clouds:
        - kubernetes:
            name: "kubernetes"
            serverUrl: "https://kubernetes.default"
            namespace: "jenkins"
            jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"

            # ðŸ”¥ IMPORTANT â€” ADDED FOR JNLP AGENT CONNECTION
            jenkinsTunnel: "jenkins.jenkins.svc.cluster.local:50000"

            webSocket: false
            containerCapStr: "30"

            templates:
              # -----------------------------------------------------
              # Default dynamic agent
              # -----------------------------------------------------
              - name: "default"
                label: "k8s"
                yamlMergeStrategy: "override"
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  metadata:
                    labels:
                      jenkins: "agent"
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: harbor-ny2n.saas-n.com/dgb/jenkins/dgb-jenkins-base-agent@sha256:b2ee4599a1af9b81dd18b928c19e737c718da1e70714ceebbfd1aea5373ad2a5
                        imagePullPolicy: IfNotPresent
                        args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
                        resources:
                          requests:
                            cpu: "100m"
                            memory: "256Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"

                      - name: alpine
                        image: alpine:3.19
                        command: ['cat']
                        tty: true
                        resources:
                          requests:
                            cpu: "50m"
                            memory: "128Mi"
                        volumeMounts:
                          - mountPath: /workspace
                            name: workspace-volume

                    volumes:
                      - name: workspace-volume
                        emptyDir: {}

              # -----------------------------------------------------
              # Agent 1
              # -----------------------------------------------------
              - name: "agent1-dynamic"
                label: "agent1"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: harbor-ny2n.saas-n.com/dgb/jenkins/dgb-jenkins-base-agent@sha256:b2ee4599a1af9b81dd18b928c19e737c718da1e70714ceebbfd1aea5373ad2a5
                        imagePullPolicy: IfNotPresent
                        args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    volumes: []

              # -----------------------------------------------------
              # Agent 2
              # -----------------------------------------------------
              - name: "agent2-dynamic"
                label: "agent2"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: harbor-ny2n.saas-n.com/dgb/jenkins/dgb-jenkins-base-agent@sha256:b2ee4599a1af9b81dd18b928c19e737c718da1e70714ceebbfd1aea5373ad2a5
                        imagePullPolicy: IfNotPresent
                        args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    volumes: []

              # -----------------------------------------------------
              # Agent 3
              # -----------------------------------------------------
              - name: "agent3-dynamic"
                label: "agent3"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: harbor-ny2n.saas-n.com/dgb/jenkins/dgb-jenkins-base-agent@sha256:b2ee4599a1af9b81dd18b928c19e737c718da1e70714ceebbfd1aea5373ad2a5
                        imagePullPolicy: IfNotPresent
                        args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    volumes: []

    unclassified:
      location:
        url: "https://jenkins.example.com/"