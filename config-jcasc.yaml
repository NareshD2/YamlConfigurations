apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-jcasc
  namespace: jenkins
data:
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins on Kubernetes (managed by JCasC)"
      numExecutors: 0
      mode: NORMAL
      disableRememberMe: true

      crumbIssuer:
        standard:
          excludeClientIPFromCrumb: true

      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "${JENKINS_ADMIN_ID}"
              password: "${JENKINS_ADMIN_PASSWORD}"

      authorizationStrategy:
        loggedInUsersCanDoAnything:
          allowAnonymousRead: false

      # Configure Kubernetes cloud for dynamic agents
      clouds:
        - kubernetes:
            name: "kubernetes"
            serverUrl: "https://kubernetes.default"
            namespace: "jenkins"
            jenkinsUrl: "http://jenkins.jenkins.svc.cluster.local:8080"
            webSocket: true
            containerCapStr: "30"   # raise global cap if you expect many parallel pods
            templates:
              # -----------------------------------------------------
              # Default dynamic agent (generic)
              # -----------------------------------------------------
              - name: "default"
                label: "k8s"
                yamlMergeStrategy: "override"
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  metadata:
                    labels:
                      jenkins: "agent"
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: jenkins/inbound-agent:latest-jdk17
                        imagePullPolicy: IfNotPresent
                        args: ['$(JENKINS_SECRET)', '$(JENKINS_NAME)']
                        resources:
                          requests:
                            cpu: "100m"
                            memory: "256Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                      - name: alpine
                        image: alpine:3.19
                        command: ['cat']
                        tty: true
                        resources:
                          requests:
                            cpu: "50m"
                            memory: "128Mi"
                        volumeMounts:
                          - mountPath: /workspace
                            name: workspace-volume
                    volumes:
                      - name: workspace-volume
                        emptyDir: {}

              # -----------------------------------------------------
              # Dynamic agent for "agent1" workloads
              # Use label: agent1
              # -----------------------------------------------------
              - name: "agent1-dynamic"
                label: "agent1"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: jenkins/inbound-agent:latest-jdk17
                        imagePullPolicy: IfNotPresent
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    # Example workspace volume (ephemeral). If you need caching, switch to a PVC.
                    volumes: []

              # -----------------------------------------------------
              # Dynamic agent for "agent2" workloads
              # Use label: agent2
              # -----------------------------------------------------
              - name: "agent2-dynamic"
                label: "agent2"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: jenkins/inbound-agent:latest-jdk17
                        imagePullPolicy: IfNotPresent
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    volumes: []

              # -----------------------------------------------------
              # Dynamic agent for "agent3" workloads
              # Use label: agent3
              # -----------------------------------------------------
              - name: "agent3-dynamic"
                label: "agent3"
                instanceCap: 5
                idleMinutes: 1
                yaml: |-
                  apiVersion: v1
                  kind: Pod
                  spec:
                    restartPolicy: Never
                    containers:
                      - name: jnlp
                        image: jenkins/inbound-agent:latest-jdk17
                        imagePullPolicy: IfNotPresent
                        resources:
                          requests:
                            cpu: "200m"
                            memory: "512Mi"
                          limits:
                            cpu: "2"
                            memory: "2Gi"
                    volumes: []

    unclassified:
      location:
        url: "https://jenkins.example.com/"